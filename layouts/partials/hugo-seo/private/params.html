{{/* 
	Creates SEO params based on page params, and site config
	
	@author @sean-au
	
	@access private

	@context Page 

	@example - Go Template
		{{ partial "hugo-seo/private/params" . }}

    */}}
 
{{/*------------------------------
	BUILDING SCRATCH SEO OBJECT
	------------------------------ */}}

{{ $config := site.Params.seo }}

{{/* Adding the seo map to scratch which will recieve SEO key/value pairs. */}}
{{ $s := newScratch }}
{{ $s.Set "params" dict  }}

{{  $s.SetInMap "params" "page" .Page   }}

{{/* Dates
	----------------------------- */}}

{{  if not .PublishDate.IsZero  }}
{{  $s.SetInMap "params" "published_time" (.PublishDate.Format "2006-01-02T15:04:05-07:00")  }}
{{  else if not .Date.IsZero  }}
{{  $s.SetInMap "params" "published_time" (.Date.Format "2006-01-02T15:04:05-07:00")  }}
{{  end  }}
{{  if not .Lastmod.IsZero  }}
{{  $s.SetInMap "params" "modified_time" (.Lastmod.Format "2006-01-02T15:04:05-07:00")  }}
{{  end  }}

{{/* Description
	----------------------------------------
	We use the following order of precedence
	1. SEO Description, then, if not found,
	2. Page Description, then if not found,
	3. Page Summary then, if not found,
	4. Site params SEO Description  
  5. Site params description 
  As it could potentially contain HTML tags, 
  we strip them with plainify                   */}}
{{ $description := "" }}
{{/* 1. SEO Description */}}
{{ if .Params.seo.description }}
	{{ $description = .Params.seo.description }}
{{/* 2. Description */}}
{{ else if .Description }}
	{{ $description = .Description }}
{{/* 3. Summary */}}
{{ else if .Summary }}
	{{ $description = .Summary }}
{{/* 4. site params seo description */}}
{{ else if $config.Description }}
  {{ $description = site.Description }}
{{/* 5. Site params description */}}
{{  else  }}
{{ $description = site.Params.description }}
{{ end }}

{{ with $description }}
	{{/* We make sure text is sanitzed before storing as data (to avoid html or markdown) */}}
	{{ $s.SetInMap "params" "description" (. | markdownify | plainify) }}
{{ end }}

{{/* page title
  ----------------------------
1. Page seo title 
2. Page title  */}}
{{ $title := .Title }}
{{ with .Params.seo.title }}
	{{ $title = . }}
{{ end }}
{{ $s.SetInMap "params" "title" $title }}

{{/* Site title
  ----------------------------
1. Site title 
2. Poorly config'd site title  */}}
{{ $siteTitle := false }}
{{ with site.Title }}
  {{ $siteTitle = . }}
{{ else }}
  {{ $siteTitle = site.Params.Title }}
{{ end }}
{{ $s.SetInMap "params" "siteTitle" $siteTitle }}
 
{{/* Title Tag
  ---------------------------- 
	We use the following logic
	1. Every pages: `{$title} | {$siteTitle}`
	2. Homepage: , only {$siteTitle}
  "|" title seperator is configured @ site.Params.seo.titleSeparator */}}
{{ if not .IsHome }}
	{{/* 1. All except home page */}}
	{{  $s.SetInMap "params" "title_tag" (printf "%s %s %s" $title $config.titleSeparator $siteTitle)  }}
{{ else }}
	{{/* 2. Home page */}}
	{{ $s.SetInMap "params" "title_tag" $siteTitle }}
{{ end }}

{{/* Site Name 
	---------------------------- */}}
{{ with $config.siteName }}
	{{ $s.SetInMap "params" "site_name" . }}
{{ else }}
	{{ $s.SetInMap "params" "site_name" $siteTitle  }}
{{ end }}

{{/* Image
	---------------------------- */}}
{{ $img := false }}
{{ $imgRes := false }}

{{  with .Params.seo.image  }}
  {{ with $.Resources.GetMatch . }}
	  {{  $img = .RelPermalink  }}
    {{ $imgRes = . }}
  {{ else }}
    {{  $img = .  }}
  {{ end }}
{{ else }}
	{{/* If no SEO IMAGE is set, we look for the .Params.images slice
		and use the first one  */}}
  {{ with .Params.images  }}
    {{ with index . 0  }}
      {{ with $.Resources.GetMatch . }}
        {{ $imgRes = . }}
        {{  $img = .RelPermalink  }}
      {{ else }}
        {{  $img = .  }}
      {{ end }}
    {{ end }}
  {{  end  }}
{{  end  }}

{{/* if image isnt found via page seo.image or .images array, use site config */}}
{{ if not $img }}
  {{ with $config.seo.image }}
    {{ with resources.GetMatch . }}
      {{ $imgRes = . }}
      {{  $img = .RelPermalink  }}
    {{ else }}
      {{  $img = .  }}
    {{ end }}
  {{ end }}
{{ end }}
	


{{/* Finally if after all of the conditional above we are not able to find an image for the page,
	we resolve to looking for the following: */}}
{{ if not $img }}
	{{  $img_defaults := slice "/static/logo.jpg" "/static/logo.png" "/uploads/default.jpg"  }}
	{{ range $path := $img_defaults }}
		{{ if fileExists . }}
			{{ $img = strings.TrimLeft "/static" $path }}
		{{ end }}
	{{ end }}
{{ end }}

{{ with $img }}
	{{ $s.SetInMap "params" "image" ( . | absURL) }}
  {{ with $imgRes.Height }}
    {{ $s.SetInMap "params" "image_height" ( . | string) }}
    {{ $s.SetInMap "params" "image_width" ( $imgRes.Width | string) }}
    {{ $s.SetInMap "params" "image_type" $imgRes.MediaType }}
  {{ else }}
    {{ $data := imageConfig $img }} 
    {{ $s.SetInMap "params" "image_height" ($data.Height | string) }}
    {{ $s.SetInMap "params" "image_width"  ($data.Height | string) }}
  {{ end }}
{{ end }}




{{/* We check for the private param 
  site.Params.seo.private: true will make
  the following return true also */}}
{{ $private :=  .Param "seo.private" }}
{{ $s.SetInMap "params" "private" $private }}





{{/* Locale 
	---------------------------- */}}
{{  $s.SetInMap "params" "locale" .Lang }}


{{/* Canonical
---------------------------- */}}
{{/* .IsNode is for list pages */}}
{{ if .IsNode }}
  {{  $s.SetInMap "params" "canonical" (.Paginator.URL | absURL) }}
  {{/* don't generate prev and next for home page (which is a node/list page) */}}
  {{ if not .IsHome }}
    {{ if .Paginator.HasPrev -}}
      {{  $s.SetInMap "params" "prev" (.Paginator.Prev.URL | absURL) }}
    {{ end }}
    {{ if .Paginator.HasNext -}}
      {{  $s.SetInMap "params" "next" (.Paginator.Next.URL | absURL) }}
    {{ end }}
  {{ end }}
{{ else }}
{{/* standard pages */}}
  {{ with .Params.seo.canonical }}
    {{  $s.SetInMap "params" "canonical" (. | absURL)  }}
  {{ else }}
    {{  $s.SetInMap "params" "canonical" .Permalink  }}
  {{ end }}
{{ end }}

{{/*  currently meta only
	---------------------------- */}}
{{ with .AlternativeOutputFormats }}
  {{ $s.SetInMap "params" "alternativeOutputFormats" . }}
{{ end }}


{{/* currently Twitter card only
	---------------------------- */}}
{{ with $img }}
	{{/* Most of the time we should have an image */}}
	{{  $s.SetInMap "params" "twitter_card" "summary_large_image"  }}
{{ else }}
	{{/* For edge cases without: */}}
	{{  $s.SetInMap "params" "twitter_card" "summary"  }}
{{ end }}

{{/* We check the site config sports a Social.twitter and use as handle */}}
{{  with .Site.Social.twitter  }}
	{{  $s.SetInMap "params" "twitter_site" (printf "@%s" .)  }}
{{  end  }}

{{/* We check the page params have author.twitter and use as handle */}}
{{  with .Params.author.twitter  }}
	{{  $s.SetInMap "params" "twitter_creator" (printf "@%s" .)  }}
{{  end  }}




{{/* currently open graph specific
	----------------------------- */}}

{{/* choose between website and article for OG */}}
{{  if in $config.ogArticleTypes .Section  }}
  {{  $s.SetInMap "params" "ogType" "article"  }}
{{ else }}
  {{  $s.SetInMap "params" "ogType" "website" }}
{{ end }}

{{ with .Section }}
  {{  $s.SetInMap "params" "section" .  }}
{{ end }}

{{- with .Params.audio }}
  {{  $s.SetInMap "params" "audio" ( . | absURL)  }}
{{ end }}

{{- with .Params.videos }}
  {{- with index . 0 }}
    {{  $s.SetInMap "params" "video" ( . | absURL)  }} />
  {{ end }}
{{ end }}

{{- with .Params.video }}
  {{  $s.SetInMap "params" "video" ( . | absURL)  }} />
{{ end }}

{{ $related := where (site.RegularPages.Related .) "Section" .Section | first 6 }}
{{ if not $related }}
{{ $related = where site.RegularPages.ByDate "Section" .Section | first 6 }}
{{ end }}
{{ with $related }}
  {{ $relatedArray := slice }}
  {{ range . }}
    {{ $relatedArray = $relatedArray | append .Permalink }}
  {{ end }}
  {{ $s.SetInMap "params" "see_also" $relatedArray }}
{{ end }}


{{ with .Translations }}
{{ $locale_alternate = slice }}
{{ range . }}
  {{ $locale_alternate = $locale_alternate | append .Lang }}
{{ end }}
{{ $s.SetInMap "params" "locale_alternate" $locale_alternate }}
{{ end }}

{{/* currently jsonld specific
	----------------------------- */}}

{{/* add jsonld type of article if match */}}
{{  if in $config.jsonldArticleTypes .Section  }}
	{{  $s.SetInMap "params" "jsonldType" "Article"  }}
{{ else if (in $config.jsonldNewsArticleTypes .Section)  }}
	{{  $s.SetInMap "params" "jsonldType" "NewsArticle"  }}
{{ else if (in $config.jsonldBlogPostingTypes .Section)  }}
	{{  $s.SetInMap "params" "jsonldType" "BlogPosting"  }}
{{ end }}

{{/* remove /n from end of plainified content */}}
{{ $articleBody := trim (.Content | plainify ) "\n" }}
{{  $s.SetInMap "params" "articleBody" $articleBody  }}

{{ with .WordCount }}
  {{  $s.SetInMap "params" "wordcount" .  }}
{{ end }}

{{ $authors := slice }}
{{ with .Params.authors }}
  {{ $authors = . }}
{{ else }}
  {{ with .Params.author }}
    {{ $authors = (slice .) }}
  {{ end }}
{{ end }}

{{ with $authors }}
{{ $s.SetInMap "params" "authors" .  }}
{{ end }}


{{ with .Parent }}
  {{ $s.SetInMap "params" "parent" . }} 
{{ end }}

{{ return $s.Get "params" }}
